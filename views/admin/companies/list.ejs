<div class="app-content content ">
  <div class="content-overlay"></div>
  <div class="header-navbar-shadow"></div>
  <div class="content-wrapper container-xxl p-0">
    <div class="content-header row">


      <div class="modal fade" id="createCategoryModal" tabindex="-1" aria-labelledby="createCategoryModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">


          <form id="companyForm" class="modal-content" enctype="multipart/form-data">
            <div class="modal-header">
              <h5 class="modal-title" id="createCompanyModalLabel">Create Company</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">

              <!-- Company Name -->
              <div class="mb-1">
                <label for="name" class="form-label">Company Name</label>
                <input type="text" class="form-control" id="name" name="name" placeholder="Company Name" />
                <div id="name-submit_errors" class="validation-error text-danger"></div>
              </div>

              <!-- Email -->
              <div class="mb-1">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control" id="email" name="email" placeholder="Email" />
                <div id="email-submit_errors" class="validation-error text-danger"></div>
              </div>

              <!-- Phone -->
              <div class="mb-1">
                <label for="phone" class="form-label">Phone</label>
                <input type="text" class="form-control" id="phone" name="phone" placeholder="Phone" />
                <div id="phone-submit_errors" class="validation-error text-danger"></div>
              </div>

              <!-- Address -->
              <div class="mb-1">
                <label for="address" class="form-label">Address</label>
                <textarea class="form-control" id="address" name="address" placeholder="Address"></textarea>
                <div id="address-submit_errors" class="validation-error text-danger"></div>
              </div>

              <!-- Latitude & Longitude -->
              <div class="row">
                <div class="col-md-6 mb-1">
                  <label for="latitude" class="form-label">Latitude</label>
                  <input type="text" class="form-control" id="latitude" name="latitude" placeholder="e.g. 28.7041" />
                  <div id="latitude-submit_errors" class="validation-error text-danger"></div>
                </div>
                <div class="col-md-6 mb-1">
                  <label for="longitude" class="form-label">Longitude</label>
                  <input type="text" class="form-control" id="longitude" name="longitude" placeholder="e.g. 77.1025" />
                  <div id="longitude-submit_errors" class="validation-error text-danger"></div>
                </div>
              </div>

              <!-- Status -->
              <div class="mb-1">
                <label for="status" class="form-label">Status</label>
                <select class="form-control" id="status" name="status">
                  <option value="">Select Status</option>
                  <option value="1">Active</option>
                  <option value="0">Inactive</option>
                </select>
                <div id="status-submit_errors" class="validation-error text-danger"></div>
              </div>

              <!-- Logo -->
              <div class="mb-1">
                <label for="logo" class="form-label">Company Logo</label>
                <input type="file" class="form-control" id="logo" name="logo" placeholder="Company Logo" />
                <div id="logo-submit_errors" class="validation-error text-danger"></div>
              </div>

            </div>

            <div class="modal-footer">
              <button type="submit" class="btn btn-success">Create</button>
            </div>
          </form>

        </div>
      </div>


      <div class="content-header-right text-md-end col-md-3 col-12 d-md-block d-none">

      

      </div>
    </div>
    <div class="content-body">


      <!-- Bordered table start -->
      <div class="row" id="table-bordered">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <!-- Flex container to align Search and Status Filter on the same line -->

              <!-- Status filter dropdown -->
              <div class="">
                <label for="statusFilter" class="form-label">Filter by Status</label>
                <select id="statusFilter" class="form-select">
                  <option value="">All</option>
                  <option value="1">Active</option>
                  <option value="0">Inactive</option>
                </select>
              </div>

              <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createCategoryModal">
                Create Company
              </button>

            </div>
            <div class="card-body">
              <div class="table-responsive card card-company-table">
                <script>
                  $(document).ready(function() {
                    var table = $('#categoriesTable').DataTable({
                      columnDefs: [{
                        orderable: false
                      }],

                      processing: true,
                      serverSide: true,
                      ajax: {
                        url: '/admin/companies/data',
                        type: 'POST',
                        contentType: 'application/json',
                        data: function(d) {
                          // Get values from both filters
                          var search = $('#searchFilter').val(); // Get search term
                          var status = $('#statusFilter').val(); // Get selected status

                          // Add search term and status filter to the data object
                          if (search) {
                            d.search = search; // Add the search term
                          }
                          if (status) {
                            d.status = status; // Add the status filter if it's selected
                          }

                          return JSON.stringify(d); // Return the modified data object

                          feather.replace();

                        }
                      },
                      columns: [{
                          data: null,
                          render: function(data, type, row, meta) {
                            return meta.settings._iDisplayStart + meta.row + 1;
                          },
                          searchable: false,
                          orderable: false
                        },
                        {
                          data: 'name'
                        },
                        {
                          data: 'status'
                        },
                        {
                          data: 'address'
                        },
                        {
                          data: 'datetime'
                        },
                        {
                          data: 'latitude'
                        },
                        {
                          data: 'longitude'
                        },
                        {
                          data: 'action'
                        }
                      ],
                      drawCallback: function(settings) {
                        feather.replace(); // Ensures icons are replaced every time table is drawn
                      }
                    });

                    // Reload table when either filter or search is changed
                    $('#statusFilter, #searchFilter').on('change keyup', function() {
                      table.ajax.reload(); // Reload DataTable on change or keyup
                    });
                  });
                </script>

                <table class="table" id="categoriesTable">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Company Name</th>
                      <th>Status</th>
                      <th>Address</th>
                      <th>Date Time</th>
                      <th>Latitude</th>
                      <th>Longitude</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>


<!-- create and edit form -->

<script>
  $(document).ready(function () {
    let editMode = false; // flag for edit
    let editId = null;

    // Create/Edit submit handler
    $('#companyForm').on('submit', function (e) {
      e.preventDefault();
      $('.validation-error').text('');

      const formData = new FormData(this);

      let url = '/admin/companies';
      let method = 'POST';

      if (editMode && editId) {
        url = '/admin/companies/' + editId;
        method = 'PUT'; // backend should support PUT/PATCH
      }

      $.ajax({
        url: url,
        method: method,
        data: formData,
        processData: false,
        contentType: false,
        success: function (response) {
          $('#createCategoryModal').modal('hide');
          $('#categoriesTable').DataTable().ajax.reload();
          showSuccessToast(editMode ? "Company updated!" : "Company created!");
          editMode = false;
          editId = null;
          $('#companyForm')[0].reset();
        },
        error: function (res) {
          if (res.status == 400 || res.status == 422) {
            if (res.responseJSON && res.responseJSON.errors) {
              var error = res.responseJSON.errors;
              $.each(error, function (key, value) {
                $("#" + key + "-submit_errors").text(value);
              });
            }
          }
          if (res.status == 500) {
            showErrorToast(res.responseJSON.error);
          }
        }
      });
    });

    // Open modal in Edit mode
    $(document).on('click', '.edit-company', function () {
      editId = $(this).data('id');
      editMode = true;

      $.get('/admin/companies/json/' + editId, function (company) {
        // Fill form values
        $('#name').val(company.name);
        $('#email').val(company.email);
        $('#phone').val(company.phone);
        $('#address').val(company.address);
        $('#latitude').val(company.latitude);
        $('#longitude').val(company.longitude);
        $('#status').val(company.status);

        // Change modal title & button
        $('#createCompanyModalLabel').text('Edit Company');
        $('#createCategoryModal').modal('show');
      });
    });

    // Reset modal when closed
    $('#createCategoryModal').on('hidden.bs.modal', function () {
      $('#companyForm')[0].reset();
      $('.validation-error').text('');
      $('#createCompanyModalLabel').text('Create Company');
      editMode = false;
      editId = null;
    });
  });
</script>



<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delete User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete <strong id="deleteUserName"></strong>?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="confirmDeleteUser" class="btn btn-danger">Delete</button>
      </div>
    </div>
  </div>
</div>




<!-- delete records js -->
<script>
  $(document).ready(function() {
    let deleteUserId = null;

    // Open modal when delete button is clicked
    $(document).on("click", ".delete-user", function() {
      deleteUserId = $(this).data("id");
      let userName = $(this).data("name");
      $("#deleteUserName").text(userName);
      $("#deleteUserModal").modal("show");
    });

    // Confirm delete
    $("#confirmDeleteUser").on("click", function() {
      if (!deleteUserId) return;

      $.ajax({
        url: "/admin/companies/" + deleteUserId, // your delete route
        type: "DELETE",
        success: function(response) {
          $("#deleteUserModal").modal("hide");
          $("#categoriesTable").DataTable().ajax.reload(); // refresh table
          showSuccessToast("User deleted successfully!");
        },
        error: function(err) {
          $("#deleteUserModal").modal("hide");
          showErrorToast("Failed to delete user!");
        }
      });
    });
  });
</script>